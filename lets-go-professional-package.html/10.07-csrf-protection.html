<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="x-ua-compatible" content="ie=edge">
		<meta name="author" content="Alex Edwards">
		<meta name="copyright" content="Copyright Alex Edwards 2025">
		<title>CSRF protection &mdash; Let's Go</title>
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<link rel="stylesheet" type="text/css" href="assets/css/main.css">
	</head>
	<body>
		<header>
			<div class="wrapper">
				<div>
					
						
						<a href="00.00-front-matter.html">Let's Go</a> <span class="crumbs">&rsaquo; <a href="10.00-user-authentication.html">User authentication</a> &rsaquo; CSRF protection</span>
						
					
				</div>
				<div>
					&lsaquo; <a href="10.06-user-authorization.html">Previous</a>
					&middot; <a href="00.01-contents.html">Contents</a> &middot;
					<a href="11.00-using-request-context.html">Next</a> &rsaquo;
				</div>
			</div>
		</header>
		<main class="wrapper text">
			<div class="chapter">Chapter 10.7.</div>
			<h2 id="csrf-protection">CSRF protection</h2>

<p>In this chapter we&rsquo;ll look at how to mitigate the risk of CSRF (<a href="https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html">cross-site request forgery</a>) attacks &mdash; a type of attack in which a malicious third-party website sends state-changing HTTP requests to your application.</p>

<aside class="note"><p>
<strong>Note:</strong> This chapter is mainly focused on the practical steps to prevent CSRF attacks in Go, rather than diving deep into an explanation of what CSRF attacks are and how they work. So if you&rsquo;re not already familiar with CSRF, I recommend reading the primers <a href="https://developer.mozilla.org/en-US/docs/Web/Security/Attacks/CSRF">here</a> or <a href="http://www.gnucitizen.org/blog/csrf-demystified/">here</a> before continuing.
</p></aside>

<p>In our application right now, the main CSRF risk looks like this:</p>

<ul>
<li><p>A user logs into our application. Our session cookie is set to persist for 12 hours, so they will remain logged in even if they navigate away from the application.</p></li>

<li><p>The user then goes to another website. This website contains some malicious code that sends a request to our <code>POST /snippet/create</code> endpoint. The user&rsquo;s web browser will automatically send the session cookie for our application along with this request.</p></li>

<li><p>Because the request includes the session cookie, our application will interpret the request as coming from a logged-in user and it will process the request with that user&rsquo;s privileges. So, completely unknown to the user, a new snippet will be added to our database by the malicious code.</p></li>
</ul>

<p>There are a variety of things we can do to prevent CSRF attacks, including setting the <code>SameSite=Lax</code> attribute on session cookies, using the <code>http.CrossOriginProtection</code> middleware in the Go standard library, and using a third-party package to implement a CSRF token check.</p>

<p>Let&rsquo;s go through them one-by-one.</p>

<aside class="important"><p>
<strong>Important:</strong> As we discussed <a href="02.05-method-based-routing.html">earlier in the book</a>, it&rsquo;s vital that you only change the state of your web application in response to <code>POST</code> requests, never <code>GET</code> requests. All the CSRF mitigations that we talk about in this chapter rely on this fundamental good-practice in order to work correctly.
</p></aside>

<h3 id="using-samesite-cookies">Using SameSite cookies</h3>

<p>One big mitigation we can take against CSRF is to make sure that the <a href="https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html#samesite-cookie-attribute"><code>SameSite=Lax</code></a> attribute is set on our session cookie. Whenever this attribute is set, the cookie <em>won&rsquo;t</em> be sent by the user&rsquo;s browser for any cross-site requests with the HTTP method <code>POST</code>.</p>

<p>By default, the <code>alexedwards/scs</code> package that we&rsquo;re using for sessions automatically sets <code>SameSite=Lax</code> on the session cookie, so we&rsquo;re already in a good place here. So long as we only ever change our application state in response to <code>POST</code> requests &mdash; never <code>GET</code> requests &mdash; our application will generally be safe from CSRF attacks.</p>

<p>However, the <code>SameSite</code> attribute is only fully supported by <a href="https://caniuse.com/#feat=same-site-cookie-attribute">95% of browsers</a> worldwide. So, although it&rsquo;s something that we can (and should) use as a defensive measure, we can&rsquo;t <em>completely</em> rely on it. And there is another potential issue &mdash; setting <code>SameSite=Lax</code> is <a href="https://medium.com/@rramgattie/samesite-and-subdomains-08870bbdd62c">not enough to prevent a CSRF attack</a> taking place from a compromised <em>subdomain</em> of your main application.</p>

<h3 id="the-http-crossoriginprotection-middleware">The http.CrossOriginProtection middleware</h3>

<p>Go 1.25 includes a new <a href="https://pkg.go.dev/net/http#CrossOriginProtection"><code>http.CrossOriginProtection</code></a> middleware type as part of the standard library. This middleware works by checking the values in the <code>Sec-Fetch-Site</code> and <code>Origin</code> request headers to determine if a request is coming from a different <em>origin</em> or not, and it will automatically reject any cross-origin <code>POST</code> requests and send the client a <code>403 Forbidden</code> response.</p>

<aside class="note"><p>
<strong>Note:</strong> It might be a bit confusing at first, but <em>cross-site</em> and <em>cross-origin</em> are <a href="https://web.dev/articles/same-site-same-origin">slightly different things</a>. For two websites to be &lsquo;same origin&rsquo; they must have the exact same scheme and host, while to be &lsquo;same site&rsquo; they only need to have the same registrable domain. For example, the two websites <code>http://www.example.com</code> and <code>https://admin.example.com</code> are still considered the &lsquo;same site&rsquo; because they both share the same registrable <code>example.com</code> domain, despite having different schemes and subdomains.</p>

<p>Both <em>cross-site</em> and <em>cross-origin</em> checks are helpful to prevent CSRF attacks, but the  cross-origin protection provided by <code>http.CrossOriginProtection</code> is stricter and safer than the cross-site protection provided by <code>SameSite=Lax</code>, because it blocks <code>POST</code> requests from websites that have a different scheme or subdomain.
</p></aside>

<p>While the <code>http.CrossOriginProtection</code> middleware is a great addition to the standard library, it&rsquo;s important to be aware that it will not provide protection for requests from older (pre-2020) browsers that do not set at least one of the <code>Sec-Fetch-Site</code> or <code>Origin</code> headers. Right now, the <code>Sec-Fetch-Site</code> header is supported by <a href="https://caniuse.com/mdn-http_headers_sec-fetch-site">92% of browsers</a> worldwide, and the <code>Origin</code> header is at <a href="https://caniuse.com/mdn-http_headers_origin">95%</a>.</p>

<h3 id="token-based-mitigation">Token-based mitigation</h3>

<p>The missing browser support for <code>SameSite</code> cookies and the <code>Sec-Fetch-Site</code> and <code>Origin</code> headers means that if we want to mitigate the risk of CSRF for <em>all</em> users, we have to fall back to implementing some form of <a href="https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html#token-based-mitigation">CSRF token check</a>. Like session management and password hashing, when it comes to this there&rsquo;s a lot that you can get wrong&hellip; so it&rsquo;s probably safest to use a tried-and-tested third-party package instead of rolling your own implementation.</p>

<p>The two most popular packages for stopping CSRF attacks in Go web applications are <a href="https://github.com/gorilla/csrf"><code>gorilla/csrf</code></a> and <a href="https://github.com/justinas/nosurf"><code>justinas/nosurf</code></a>. They both do roughly the same thing, using the <a href="https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html#double-submit-cookie">double-submit cookie</a> pattern. In this pattern a random <dfn>CSRF token</dfn> is generated and sent to the user in a <dfn>CSRF cookie</dfn>. This CSRF token is then added to a hidden field in each HTML form that is potentially vulnerable to CSRF. When the form is submitted, both packages use some middleware to check that the hidden field value and cookie value match.</p>

<p>Out of the two packages, we’ll opt to use <code>justinas/nosurf</code> in this book. I prefer it primarily because it’s self-contained and doesn’t have any additional dependencies, and it&rsquo;s also a bit more actively maintained. If you&rsquo;re following along, you can install the latest version like so:</p>

<figure class="code bash">
<pre>$ go get github.com/justinas/nosurf@v1
<samp>go: downloading github.com/justinas/nosurf v1.2.0
go get: added github.com/justinas/nosurf v1.2.0</samp></pre>
</figure>

<h3 id="using-the-nosurf-package">Using the nosurf package</h3>

<p>To use <code>justinas/nosurf</code>, open up your <code>cmd/web/middleware.go</code> file and create a new <code>preventCSRF()</code> middleware function like so:</p>

<figure class="code go">
<figcaption>File: cmd/web/middleware.go</figcaption>
<pre><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;net/http&#34;</span>

    <span class="s">&#34;github.com/justinas/nosurf&#34;</span> <span class="c1">// New import
</span><span class="c1"></span><span class="p">)</span>

<span class="o">...</span>

<span class="c1">// Create a preventCSRF middleware function which uses a customized CSRF cookie with
</span><span class="c1"></span><span class="c1">// the Secure, Path and HttpOnly attributes set.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">preventCSRF</span><span class="p">(</span><span class="nx">next</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span> <span class="p">{</span>
    <span class="nx">csrfHandler</span> <span class="o">:=</span> <span class="nx">nosurf</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span>
    <span class="nx">csrfHandler</span><span class="p">.</span><span class="nf">SetBaseCookie</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">Cookie</span><span class="p">{</span>
        <span class="nx">HttpOnly</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">Path</span><span class="p">:</span>     <span class="s">&#34;/&#34;</span><span class="p">,</span>
        <span class="nx">Secure</span><span class="p">:</span>   <span class="kc">true</span><span class="p">,</span>
    <span class="p">}</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">csrfHandler</span>
<span class="p">}</span></pre>
</figure>

<p>One of the forms that we need to protect from CSRF attacks is our logout form, which is included in our <code>nav.tmpl</code> partial and could potentially appear on any page of our application. So, because of this, we need to use our <code>preventCSRF()</code> middleware on <em>all</em> of our application routes (apart from <code>GET /static/</code>).</p>

<p>So, let&rsquo;s update the <code>cmd/web/routes.go</code> file to add this <code>preventCSRF()</code> middleware to the <code>dynamic</code> middleware chain that we made earlier:</p>

<figure class="code go">
<figcaption>File: cmd/web/routes.go</figcaption>
<pre><span class="kn">package</span> <span class="nx">main</span>

<span class="o">...</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">app</span> <span class="o">*</span><span class="nx">application</span><span class="p">)</span> <span class="nf">routes</span><span class="p">(</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span> <span class="p">{</span>
     <span class="nx">mux</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">NewServeMux</span><span class="p">(</span><span class="p">)</span>

    <span class="nx">fileServer</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">FileServer</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nf">Dir</span><span class="p">(</span><span class="s">&#34;./ui/static/&#34;</span><span class="p">)</span><span class="p">)</span>
    <span class="nx">mux</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;GET /static/&#34;</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nf">StripPrefix</span><span class="p">(</span><span class="s">&#34;/static&#34;</span><span class="p">,</span> <span class="nx">fileServer</span><span class="p">)</span><span class="p">)</span>

    <span class="c1">// Use the nosurf middleware on all our &#39;dynamic&#39; routes.
</span><span class="c1"></span>    <span class="nx">dynamic</span> <span class="o">:=</span> <span class="nx">alice</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">sessionManager</span><span class="p">.</span><span class="nx">LoadAndSave</span><span class="p">,</span> <span class="nx">preventCSRF</span><span class="p">)</span>

    <span class="nx">mux</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;GET /{$}&#34;</span><span class="p">,</span> <span class="nx">dynamic</span><span class="p">.</span><span class="nf">ThenFunc</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">home</span><span class="p">)</span><span class="p">)</span>
    <span class="nx">mux</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;GET /snippet/view/{id}&#34;</span><span class="p">,</span> <span class="nx">dynamic</span><span class="p">.</span><span class="nf">ThenFunc</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">snippetView</span><span class="p">)</span><span class="p">)</span>
    <span class="nx">mux</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;GET /user/signup&#34;</span><span class="p">,</span> <span class="nx">dynamic</span><span class="p">.</span><span class="nf">ThenFunc</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">userSignup</span><span class="p">)</span><span class="p">)</span>
    <span class="nx">mux</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;POST /user/signup&#34;</span><span class="p">,</span> <span class="nx">dynamic</span><span class="p">.</span><span class="nf">ThenFunc</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">userSignupPost</span><span class="p">)</span><span class="p">)</span>
    <span class="nx">mux</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;GET /user/login&#34;</span><span class="p">,</span> <span class="nx">dynamic</span><span class="p">.</span><span class="nf">ThenFunc</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">userLogin</span><span class="p">)</span><span class="p">)</span>
    <span class="nx">mux</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;POST /user/login&#34;</span><span class="p">,</span> <span class="nx">dynamic</span><span class="p">.</span><span class="nf">ThenFunc</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">userLoginPost</span><span class="p">)</span><span class="p">)</span>

    <span class="nx">protected</span> <span class="o">:=</span> <span class="nx">dynamic</span><span class="p">.</span><span class="nf">Append</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">requireAuthentication</span><span class="p">)</span>

    <span class="nx">mux</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;GET /snippet/create&#34;</span><span class="p">,</span> <span class="nx">protected</span><span class="p">.</span><span class="nf">ThenFunc</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">snippetCreate</span><span class="p">)</span><span class="p">)</span>
    <span class="nx">mux</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;POST /snippet/create&#34;</span><span class="p">,</span> <span class="nx">protected</span><span class="p">.</span><span class="nf">ThenFunc</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">snippetCreatePost</span><span class="p">)</span><span class="p">)</span>
    <span class="nx">mux</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;POST /user/logout&#34;</span><span class="p">,</span> <span class="nx">protected</span><span class="p">.</span><span class="nf">ThenFunc</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">userLogoutPost</span><span class="p">)</span><span class="p">)</span>

    <span class="nx">standard</span> <span class="o">:=</span> <span class="nx">alice</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">recoverPanic</span><span class="p">,</span> <span class="nx">app</span><span class="p">.</span><span class="nx">logRequest</span><span class="p">,</span> <span class="nx">commonHeaders</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">standard</span><span class="p">.</span><span class="nf">Then</span><span class="p">(</span><span class="nx">mux</span><span class="p">)</span>
<span class="p">}</span></pre>
</figure>

<p>At this point, you might like to fire up the application and try submitting one of the forms. When you do, the request should be intercepted by the <code>preventCSRF()</code> middleware and you should receive a <code>400 Bad Request</code> response.</p>

<figure class="img">
<img src="assets/img/10.07-01.png" alt="10.07-01.png" />
</figure>

<p>To make the form submissions work, we need to use the <a href="https://pkg.go.dev/github.com/justinas/nosurf?utm_source=godoc#Token"><code>nosurf.Token()</code></a> function to get the CSRF token and add it to a hidden <code>csrf_token</code> field in each of our forms. So the next step is to add a new <code>CSRFToken</code> field to our <code>templateData</code> struct:</p>

<figure class="code go">
<figcaption>File: cmd/web/templates.go</figcaption>
<pre><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;html/template&#34;</span>
    <span class="s">&#34;path/filepath&#34;</span>
    <span class="s">&#34;time&#34;</span>

    <span class="s">&#34;snippetbox.alexedwards.net/internal/models&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">templateData</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">CurrentYear</span>     <span class="kt">int</span>
    <span class="nx">Snippet</span>         <span class="nx">models</span><span class="p">.</span><span class="nx">Snippet</span>
    <span class="nx">Snippets</span>        <span class="p">[</span><span class="p">]</span><span class="nx">models</span><span class="p">.</span><span class="nx">Snippet</span>
    <span class="nx">Form</span>            <span class="nx">any</span>
    <span class="nx">Flash</span>           <span class="kt">string</span>
    <span class="nx">IsAuthenticated</span> <span class="kt">bool</span>
    <span class="nx">CSRFToken</span>       <span class="kt">string</span> <span class="c1">// Add a CSRFToken field.
</span><span class="c1"></span><span class="p">}</span>

<span class="o">...</span></pre>
</figure>

<p>And because the logout form can potentially appear on every page, it makes sense to add the CSRF token to the template data automatically via our <code>newTemplateData()</code> helper. This will mean that it will be available to our templates each time we render a page.</p>

<p>Please go ahead and update the <code>cmd/web/helpers.go</code> file as follows:</p>

<figure class="code go">
<figcaption>File: cmd/web/helpers.go</figcaption>
<pre><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;bytes&#34;</span>
    <span class="s">&#34;errors&#34;</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;net/http&#34;</span>
    <span class="s">&#34;time&#34;</span>

    <span class="s">&#34;github.com/go-playground/form/v4&#34;</span>
    <span class="s">&#34;github.com/justinas/nosurf&#34;</span> <span class="c1">// New import
</span><span class="c1"></span><span class="p">)</span>

<span class="o">...</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">app</span> <span class="o">*</span><span class="nx">application</span><span class="p">)</span> <span class="nf">newTemplateData</span><span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="nx">templateData</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">templateData</span><span class="p">{</span>
        <span class="nx">CurrentYear</span><span class="p">:</span>     <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nf">Year</span><span class="p">(</span><span class="p">)</span><span class="p">,</span>
        <span class="nx">Flash</span><span class="p">:</span>           <span class="nx">app</span><span class="p">.</span><span class="nx">sessionManager</span><span class="p">.</span><span class="nf">PopString</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nf">Context</span><span class="p">(</span><span class="p">)</span><span class="p">,</span> <span class="s">&#34;flash&#34;</span><span class="p">)</span><span class="p">,</span>
        <span class="nx">IsAuthenticated</span><span class="p">:</span> <span class="nx">app</span><span class="p">.</span><span class="nf">isAuthenticated</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span><span class="p">,</span>
        <span class="nx">CSRFToken</span><span class="p">:</span>       <span class="nx">nosurf</span><span class="p">.</span><span class="nf">Token</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span><span class="p">,</span> <span class="c1">// Add the CSRF token.
</span><span class="c1"></span>    <span class="p">}</span>
<span class="p">}</span>

<span class="o">...</span></pre>
</figure>

<p>Finally, we need to update all the forms in our application to include this CSRF token in a hidden field.</p>

<p>Like so:</p>

<figure class="code html">
<figcaption>File: ui/html/pages/create.tmpl</figcaption>
<pre>{{define &#34;title&#34;}}Create a New Snippet{{end}}

{{define &#34;main&#34;}}
<span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&#39;/snippet/create&#39;</span> <span class="na">method</span><span class="o">=</span><span class="s">&#39;POST&#39;</span><span class="p"></span><span class="p">&gt;</span>
    <span class="c">&lt;!--</span><span class="c"> Include the CSRF token </span><span class="c">--&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#39;hidden&#39;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#39;csrf_token&#39;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;{{.CSRFToken}}&#39;</span><span class="p"></span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p"></span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">label</span><span class="p"></span><span class="p">&gt;</span>Title:<span class="p">&lt;</span><span class="p">/</span><span class="nt">label</span><span class="p">&gt;</span>
        {{with .Form.FieldErrors.title}}
            <span class="p">&lt;</span><span class="nt">label</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;error&#39;</span><span class="p"></span><span class="p">&gt;</span>{{.}}<span class="p">&lt;</span><span class="p">/</span><span class="nt">label</span><span class="p">&gt;</span>
        {{end}}
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#39;text&#39;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#39;title&#39;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;{{.Form.Title}}&#39;</span><span class="p"></span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="p">/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p"></span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">label</span><span class="p"></span><span class="p">&gt;</span>Content:<span class="p">&lt;</span><span class="p">/</span><span class="nt">label</span><span class="p">&gt;</span>
        {{with .Form.FieldErrors.content}}
            <span class="p">&lt;</span><span class="nt">label</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;error&#39;</span><span class="p"></span><span class="p">&gt;</span>{{.}}<span class="p">&lt;</span><span class="p">/</span><span class="nt">label</span><span class="p">&gt;</span>
        {{end}}
        <span class="p">&lt;</span><span class="nt">textarea</span> <span class="na">name</span><span class="o">=</span><span class="s">&#39;content&#39;</span><span class="p"></span><span class="p">&gt;</span>{{.Form.Content}}<span class="p">&lt;</span><span class="p">/</span><span class="nt">textarea</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="p">/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p"></span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">label</span><span class="p"></span><span class="p">&gt;</span>Delete in:<span class="p">&lt;</span><span class="p">/</span><span class="nt">label</span><span class="p">&gt;</span>
        {{with .Form.FieldErrors.expires}}
            <span class="p">&lt;</span><span class="nt">label</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;error&#39;</span><span class="p"></span><span class="p">&gt;</span>{{.}}<span class="p">&lt;</span><span class="p">/</span><span class="nt">label</span><span class="p">&gt;</span>
        {{end}}
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#39;radio&#39;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#39;expires&#39;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;365&#39;</span> <span class="err">{</span><span class="err">{</span><span class="na">if</span> <span class="err">(</span><span class="na">eq</span> <span class="err">.</span><span class="na">Form</span><span class="err">.</span><span class="na">Expires</span> <span class="na">365</span><span class="err">)</span><span class="err">}</span><span class="err">}</span><span class="na">checked</span><span class="err">{</span><span class="err">{</span><span class="na">end</span><span class="err">}</span><span class="err">}</span><span class="p"></span><span class="p">&gt;</span> One Year
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#39;radio&#39;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#39;expires&#39;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;7&#39;</span> <span class="err">{</span><span class="err">{</span><span class="na">if</span> <span class="err">(</span><span class="na">eq</span> <span class="err">.</span><span class="na">Form</span><span class="err">.</span><span class="na">Expires</span> <span class="na">7</span><span class="err">)</span><span class="err">}</span><span class="err">}</span><span class="na">checked</span><span class="err">{</span><span class="err">{</span><span class="na">end</span><span class="err">}</span><span class="err">}</span><span class="p"></span><span class="p">&gt;</span> One Week
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#39;radio&#39;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#39;expires&#39;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;1&#39;</span> <span class="err">{</span><span class="err">{</span><span class="na">if</span> <span class="err">(</span><span class="na">eq</span> <span class="err">.</span><span class="na">Form</span><span class="err">.</span><span class="na">Expires</span> <span class="na">1</span><span class="err">)</span><span class="err">}</span><span class="err">}</span><span class="na">checked</span><span class="err">{</span><span class="err">{</span><span class="na">end</span><span class="err">}</span><span class="err">}</span><span class="p"></span><span class="p">&gt;</span> One Day
    <span class="p">&lt;</span><span class="p">/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p"></span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#39;submit&#39;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;Publish snippet&#39;</span><span class="p"></span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="p">/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="p">/</span><span class="nt">form</span><span class="p">&gt;</span>
{{end}}</pre>
</figure>

<figure class="code html">
<figcaption>File: ui/html/pages/login.tmpl</figcaption>
<pre>{{define &#34;title&#34;}}Login{{end}}

{{define &#34;main&#34;}}
<span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&#39;/user/login&#39;</span> <span class="na">method</span><span class="o">=</span><span class="s">&#39;POST&#39;</span> <span class="na">novalidate</span><span class="p"></span><span class="p">&gt;</span>
    <span class="c">&lt;!--</span><span class="c"> Include the CSRF token </span><span class="c">--&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#39;hidden&#39;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#39;csrf_token&#39;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;{{.CSRFToken}}&#39;</span><span class="p"></span><span class="p">&gt;</span>
    {{range .Form.NonFieldErrors}}
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;error&#39;</span><span class="p"></span><span class="p">&gt;</span>{{.}}<span class="p">&lt;</span><span class="p">/</span><span class="nt">div</span><span class="p">&gt;</span>
    {{end}}
    <span class="p">&lt;</span><span class="nt">div</span><span class="p"></span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">label</span><span class="p"></span><span class="p">&gt;</span>Email:<span class="p">&lt;</span><span class="p">/</span><span class="nt">label</span><span class="p">&gt;</span>
        {{with .Form.FieldErrors.email}}
            <span class="p">&lt;</span><span class="nt">label</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;error&#39;</span><span class="p"></span><span class="p">&gt;</span>{{.}}<span class="p">&lt;</span><span class="p">/</span><span class="nt">label</span><span class="p">&gt;</span>
        {{end}}
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#39;email&#39;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#39;email&#39;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;{{.Form.Email}}&#39;</span><span class="p"></span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="p">/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p"></span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">label</span><span class="p"></span><span class="p">&gt;</span>Password:<span class="p">&lt;</span><span class="p">/</span><span class="nt">label</span><span class="p">&gt;</span>
        {{with .Form.FieldErrors.password}}
            <span class="p">&lt;</span><span class="nt">label</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;error&#39;</span><span class="p"></span><span class="p">&gt;</span>{{.}}<span class="p">&lt;</span><span class="p">/</span><span class="nt">label</span><span class="p">&gt;</span>
        {{end}}
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#39;password&#39;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#39;password&#39;</span><span class="p"></span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="p">/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p"></span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#39;submit&#39;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;Login&#39;</span><span class="p"></span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="p">/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="p">/</span><span class="nt">form</span><span class="p">&gt;</span>
{{end}}</pre>
</figure>

<figure class="code html">
<figcaption>File: ui/html/pages/signup.tmpl</figcaption>
<pre>{{define &#34;title&#34;}}Signup{{end}}

{{define &#34;main&#34;}}
<span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&#39;/user/signup&#39;</span> <span class="na">method</span><span class="o">=</span><span class="s">&#39;POST&#39;</span> <span class="na">novalidate</span><span class="p"></span><span class="p">&gt;</span>
    <span class="c">&lt;!--</span><span class="c"> Include the CSRF token </span><span class="c">--&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#39;hidden&#39;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#39;csrf_token&#39;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;{{.CSRFToken}}&#39;</span><span class="p"></span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p"></span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">label</span><span class="p"></span><span class="p">&gt;</span>Name:<span class="p">&lt;</span><span class="p">/</span><span class="nt">label</span><span class="p">&gt;</span>
        {{with .Form.FieldErrors.name}}
            <span class="p">&lt;</span><span class="nt">label</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;error&#39;</span><span class="p"></span><span class="p">&gt;</span>{{.}}<span class="p">&lt;</span><span class="p">/</span><span class="nt">label</span><span class="p">&gt;</span>
        {{end}}
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#39;text&#39;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#39;name&#39;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;{{.Form.Name}}&#39;</span><span class="p"></span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="p">/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p"></span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">label</span><span class="p"></span><span class="p">&gt;</span>Email:<span class="p">&lt;</span><span class="p">/</span><span class="nt">label</span><span class="p">&gt;</span>
        {{with .Form.FieldErrors.email}}
            <span class="p">&lt;</span><span class="nt">label</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;error&#39;</span><span class="p"></span><span class="p">&gt;</span>{{.}}<span class="p">&lt;</span><span class="p">/</span><span class="nt">label</span><span class="p">&gt;</span>
        {{end}}
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#39;email&#39;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#39;email&#39;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;{{.Form.Email}}&#39;</span><span class="p"></span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="p">/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p"></span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">label</span><span class="p"></span><span class="p">&gt;</span>Password:<span class="p">&lt;</span><span class="p">/</span><span class="nt">label</span><span class="p">&gt;</span>
        {{with .Form.FieldErrors.password}}
            <span class="p">&lt;</span><span class="nt">label</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;error&#39;</span><span class="p"></span><span class="p">&gt;</span>{{.}}<span class="p">&lt;</span><span class="p">/</span><span class="nt">label</span><span class="p">&gt;</span>
        {{end}}
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#39;password&#39;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#39;password&#39;</span><span class="p"></span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="p">/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p"></span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#39;submit&#39;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;Signup&#39;</span><span class="p"></span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="p">/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="p">/</span><span class="nt">form</span><span class="p">&gt;</span>
{{end}}</pre>
</figure>

<figure class="code html">
<figcaption>File: ui/html/partials/nav.tmpl</figcaption>
<pre>{{define &#34;nav&#34;}}
<span class="p">&lt;</span><span class="nt">nav</span><span class="p"></span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p"></span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#39;/&#39;</span><span class="p"></span><span class="p">&gt;</span>Home<span class="p">&lt;</span><span class="p">/</span><span class="nt">a</span><span class="p">&gt;</span>
         {{if .IsAuthenticated}}
            <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#39;/snippet/create&#39;</span><span class="p"></span><span class="p">&gt;</span>Create snippet<span class="p">&lt;</span><span class="p">/</span><span class="nt">a</span><span class="p">&gt;</span>
        {{end}}
    <span class="p">&lt;</span><span class="p">/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p"></span><span class="p">&gt;</span>
        {{if .IsAuthenticated}}
            <span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&#39;/user/logout&#39;</span> <span class="na">method</span><span class="o">=</span><span class="s">&#39;POST&#39;</span><span class="p"></span><span class="p">&gt;</span>
                <span class="c">&lt;!--</span><span class="c"> Include the CSRF token </span><span class="c">--&gt;</span>
                <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#39;hidden&#39;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#39;csrf_token&#39;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;{{.CSRFToken}}&#39;</span><span class="p"></span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">button</span><span class="p"></span><span class="p">&gt;</span>Logout<span class="p">&lt;</span><span class="p">/</span><span class="nt">button</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="p">/</span><span class="nt">form</span><span class="p">&gt;</span>
        {{else}}
            <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#39;/user/signup&#39;</span><span class="p"></span><span class="p">&gt;</span>Signup<span class="p">&lt;</span><span class="p">/</span><span class="nt">a</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#39;/user/login&#39;</span><span class="p"></span><span class="p">&gt;</span>Login<span class="p">&lt;</span><span class="p">/</span><span class="nt">a</span><span class="p">&gt;</span>
        {{end}}
    <span class="p">&lt;</span><span class="p">/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="p">/</span><span class="nt">nav</span><span class="p">&gt;</span>
{{end}}</pre>
</figure>

<p>Go ahead and run the application again, then <em>view source</em> of one of the forms. You should see that it now includes a CSRF token included in a hidden field, like so.</p>

<figure class="img">
<img src="assets/img/10.07-02.png" alt="10.07-02.png" />
</figure>

<p>And if you try submitting the forms, it should now work correctly again.</p>

<hr />

<h3 id="additional-information">Additional information</h3>

<h4 id="a-modern-approach-to-preventing-csrf">A modern approach to preventing CSRF</h4>

<p>Earlier in this chapter, I said that we can&rsquo;t only rely on the <code>SameSite=Lax</code> cookie attribute to prevent CSRF attacks because it isn&rsquo;t fully supported by all browsers.</p>

<p>But there is an <a href="https://security.stackexchange.com/a/249636">exception to this</a> rule, due to the fact that <em>all browsers which support TLS 1.3 also support <code>SameSite</code> cookies</em>.</p>

<p>So, if you set TLS 1.3 the minimum supported version in the TLS config for your server, you can be confident that any browser using your application will support <code>SameSite</code> cookies, and setting <code>SameSite=Lax</code> on the session cookie is enough to prevent cross-site (but not necessarily cross-origin) CSRF attacks.</p>

<figure class="code go">
<pre><span class="nx">tlsConfig</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">tls</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
    <span class="nx">MinVersion</span><span class="p">:</span> <span class="nx">tls</span><span class="p">.</span><span class="nx">VersionTLS13</span><span class="p">,</span>
<span class="p">}</span></pre>
</figure>

<p>As a defense-in-depth measure, and to mitigate the risk of a cross-origin CSRF attack from a subdomain, it is a good idea to also use the <code>http.CrossOriginProtection</code> functionality in the standard library. At its simplest, that would mean updating your <code>preventCSRF</code> middleware to look like this:</p>

<figure class="code go">
<pre><span class="kd">func</span> <span class="nf">preventCSRF</span><span class="p">(</span><span class="nx">next</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span> <span class="p">{</span>
	<span class="nx">cop</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">NewCrossOriginProtection</span><span class="p">(</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">cop</span><span class="p">.</span><span class="nf">Handler</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span>
<span class="p">}</span></pre>
</figure>

<p>If you want, you can also configure it to allow <code>POST</code> requests from other specific trusted origins, or change the default error response like so:</p>

<figure class="code go">
<pre><span class="kd">func</span> <span class="p">(</span><span class="nx">app</span> <span class="o">*</span><span class="nx">application</span><span class="p">)</span> <span class="nf">preventCSRF</span><span class="p">(</span><span class="nx">next</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span> <span class="p">{</span>
	<span class="nx">cop</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">NewCrossOriginProtection</span><span class="p">(</span><span class="p">)</span>

	<span class="nx">cop</span><span class="p">.</span><span class="nf">AddTrustedOrigin</span><span class="p">(</span><span class="s">&#34;https://foo.example.com&#34;</span><span class="p">)</span>

	<span class="nx">cop</span><span class="p">.</span><span class="nf">SetDenyHandler</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">w</span><span class="p">.</span><span class="nf">WriteHeader</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusBadRequest</span><span class="p">)</span>
		<span class="nx">w</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="p">[</span><span class="p">]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;CSRF check failed&#34;</span><span class="p">)</span><span class="p">)</span>
	<span class="p">}</span><span class="p">)</span><span class="p">)</span>

	<span class="k">return</span> <span class="nx">cop</span><span class="p">.</span><span class="nf">Handler</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span>
<span class="p">}</span></pre>
</figure>

<p>This combination of three things &mdash; enforcing the use of TLS 1.3, using <code>SameSite=Lax</code> on your session cookie, and the <code>http.CrossOriginProtection</code> middleware is a pretty robust approach to preventing CSRF attacks.</p>

<p>It&rsquo;s not 100% perfect though. There is a small group of old web browsers (including Firefox versions 63-69) that support TLS 1.3 but <em>don&rsquo;t</em> include the <code>Sec-Fetch-Site</code> or <code>Origin</code> header in <code>POST</code> requests. For those browsers, the <code>http.CrossOriginProtection</code> middleware won&rsquo;t work, meaning that there remains a risk of a CSRF attack from a compromised subdomain.</p>

<p>But if you don&rsquo;t have any subdomains, and are happy to enforce TLS 1.3, this modern approach to preventing CSRF is a good option, and much cleaner and simpler than using <code>nosurf</code> and adding CSRF tokens to all your forms.</p>

<h4 id="samesite-strict-setting">SameSite &lsquo;Strict&rsquo; setting</h4>

<p>If you want, you can change the session cookie to use the <code>SameSite=Strict</code> setting instead of (the default) <code>SameSite=Lax</code>. Like this:</p>

<figure class="code go">
<pre><span class="nx">sessionManager</span> <span class="o">:=</span> <span class="nx">scs</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="p">)</span>
<span class="nx">sessionManager</span><span class="p">.</span><span class="nx">Cookie</span><span class="p">.</span><span class="nx">SameSite</span> <span class="p">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">SameSiteStrictMode</span></pre>
</figure>

<p>But it&rsquo;s important to be aware that using <code>SameSite=Strict</code> will block the session cookie from being sent by the user&rsquo;s browser for <em>all</em> cross-site usage &mdash; including <a href="https://datatracker.ietf.org/doc/html/rfc7231#section-4.2.1">safe</a> requests with HTTP methods like <code>GET</code> and <code>HEAD</code>.</p>

<p>While that might sound even safer (and it is!) the downside is that the session cookie won&rsquo;t be sent when a user clicks on a link to your application from another website. In turn, that means that your application will initially treat the user as &lsquo;not logged in&rsquo; even if they have an active session containing their <code>&quot;authenticatedUserID&quot;</code> value.</p>

<p>So if your application will potentially have other websites linking to it (or links to it shared in emails or private messaging services), then <code>SameSite=Lax</code> is generally the more appropriate setting.</p>

		</main>
		<footer>
			<div class="wrapper">
				<div>
					&lsaquo; <a href="10.06-user-authorization.html">Previous</a>
				</div>
				<div>
					<a href="00.01-contents.html">Contents</a>
				</div>
				<div>
					<a href="11.00-using-request-context.html">Next</a> &rsaquo;
				</div>
			</div>
		</footer>
		<script>
			document.onkeydown = function(evt) {
				evt = evt || window.event;
				switch (evt.keyCode) {
					
					case 37:
						window.location.href = "10.06-user-authorization.html";
						break;
						
					
					case 39:
						window.location.href = "11.00-using-request-context.html";
						break;
						
				}
			};
		</script>
	</body>
</html>

